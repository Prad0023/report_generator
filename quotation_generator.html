<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quotation Generator - Sambhav AI & TECH Services</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #F97316;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #EA580C;
        }
        .searchable-dropdown-container {
            position: relative;
        }
        .searchable-dropdown-list {
            position: absolute;
            background-color: white;
            border: 1px solid #e5e7eb;
            border-top: none;
            z-index: 10;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-radius: 0 0 0.375rem 0.375rem;
        }
        .searchable-dropdown-item {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
        }
        .searchable-dropdown-item:hover {
            background-color: #FFF7ED;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <div class="bg-white rounded-lg shadow-xl p-6 sm:p-8">
            <div class="text-center mb-8">
                <img src="YOUR_LOGO_URL_HERE.png" alt="Sambhav AI & TECH Services Logo" id="companyLogoDisplay" class="mx-auto h-20 sm:h-24 mb-4"> 
                <h1 class="text-3xl font-bold text-orange-600">Quotation Generator</h1>
                <p class="text-sm text-gray-600">Sambhav AI & TECH Services</p>
            </div>
            
            <div class="mb-8 p-4 border border-orange-200 rounded-lg bg-orange-50">
                <h2 class="text-xl font-semibold text-orange-700 mb-3">Company Information</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2 text-sm text-gray-700">
                    <div><strong>Name:</strong> Sambhav AI & TECH Services</div>
                    <div><strong>Website:</strong> <a href="https://sambhavaintech.com" target="_blank" class="text-orange-600 hover:text-orange-700 underline">sambhavaintech.com</a></div>
                    <div><strong>Contact:</strong> 8600722160</div>
                    <div><strong>Email:</strong> <a href="mailto:business@sambhavaintech.com" class="text-orange-600 hover:text-orange-700 underline">business@sambhavaintech.com</a></div>
                </div>
            </div>

            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Client Information</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Client Name *</label>
                        <input type="text" id="clientName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Client Contact *</label>
                        <input type="text" id="clientContact" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" required>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Client Address *</label>
                        <textarea id="clientAddress" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" required></textarea>
                    </div>
                </div>
            </div>

            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Quotation Details</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Quotation Number *</label>
                        <input type="text" id="quotationNumber" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Date *</label>
                        <input type="date" id="quotationDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Valid Until *</label>
                        <input type="date" id="validUntil" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" required>
                    </div>
                    <div class="md:col-span-3">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Reference Site (Optional)</label>
                        <input type="url" id="referenceSite" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="https://example.com">
                    </div>
                </div>
            </div>

            <div class="mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">Services</h2>
                    <button onclick="addService()" class="bg-orange-500 text-white px-4 py-2 rounded-md hover:bg-orange-600 transition duration-200 shadow-md">+ Add Service</button>
                </div>
                <div id="servicesContainer" class="space-y-4">
                </div>
            </div>
            
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Services Overview</h2>
                <div class="overflow-x-auto rounded-lg border border-gray-200">
                    <table class="w-full">
                        <thead class="bg-gray-700 text-white">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Service Name</th>
                                <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Description</th>
                                <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Payment Term</th>
                                <th class="px-4 py-3 text-right text-xs font-medium uppercase tracking-wider">One-Time Cost</th>
                                <th class="px-4 py-3 text-right text-xs font-medium uppercase tracking-wider">Monthly Cost</th>
                                <th class="px-4 py-3 text-right text-xs font-medium uppercase tracking-wider">Yearly Cost</th>
                            </tr>
                        </thead>
                        <tbody id="servicesTable" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Cost Summary</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-orange-50 p-4 rounded-lg shadow">
                        <h3 class="font-semibold text-orange-700 mb-2">One-Time Payment</h3>
                        <div class="space-y-1 text-sm text-gray-700">
                            <div class="flex justify-between"><span>Subtotal:</span><span id="oneTimeSubtotal">₹0.00</span></div>
                            <div class="flex justify-between"><span>Tax (10%):</span><span id="oneTimeTax">₹0.00</span></div>
                            <div class="flex justify-between font-bold text-gray-800 border-t border-orange-200 pt-1 mt-1"><span>Total:</span><span id="oneTimeTotal">₹0.00</span></div>
                        </div>
                    </div>
                    <div class="bg-orange-50 p-4 rounded-lg shadow">
                        <h3 class="font-semibold text-orange-700 mb-2">Monthly Payment</h3>
                        <div class="space-y-1 text-sm text-gray-700">
                            <div class="flex justify-between"><span>Subtotal:</span><span id="monthlySubtotal">₹0.00</span></div>
                            <div class="flex justify-between"><span>Tax (10%):</span><span id="monthlyTax">₹0.00</span></div>
                            <div class="flex justify-between font-bold text-gray-800 border-t border-orange-200 pt-1 mt-1"><span>Total:</span><span id="monthlyTotal">₹0.00</span></div>
                        </div>
                    </div>
                    <div class="bg-orange-50 p-4 rounded-lg shadow">
                        <h3 class="font-semibold text-orange-700 mb-2">Yearly Payment</h3>
                        <div class="space-y-1 text-sm text-gray-700">
                            <div class="flex justify-between"><span>Subtotal:</span><span id="yearlySubtotal">₹0.00</span></div>
                            <div class="flex justify-between"><span>Tax (10%):</span><span id="yearlyTax">₹0.00</span></div>
                            <div class="flex justify-between font-bold text-gray-800 border-t border-orange-200 pt-1 mt-1"><span>Total:</span><span id="yearlyTotal">₹0.00</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Terms and Conditions</h2>
                <textarea id="termsConditions" rows="8" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500 text-sm">1. Payment Terms: Payment is due within 30 days of invoice date.
2. Scope of Work: This quotation covers the services outlined above. Any additional work will be quoted separately.
3. Validity: This quotation is valid for 30 days from the date mentioned above.
4. Cancellation: Either party may cancel this agreement with 30 days written notice for recurring services.
5. Intellectual Property: Upon full payment for custom development (one-time services), intellectual property rights for the deliverables will transfer to the client, unless otherwise specified for licensed software/platforms or ongoing services.
6. Liability: Our liability is limited to the total value of this contract for the specific service in question.
7. Force Majeure: Neither party shall be liable for delays due to circumstances beyond their control.
8. Governing Law: This agreement shall be governed by the laws of [Your Jurisdiction, e.g., India].</textarea>
            </div>

            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <button onclick="saveData()" class="bg-gray-700 text-white px-6 py-3 rounded-md hover:bg-black transition duration-200 shadow-md">Save Data</button>
                <button onclick="loadData()" class="bg-gray-700 text-white px-6 py-3 rounded-md hover:bg-black transition duration-200 shadow-md">Load Saved Data</button>
                <button onclick="generatePDF()" class="bg-orange-500 text-white px-6 py-3 rounded-md hover:bg-orange-600 transition duration-200 shadow-md font-semibold">Download PDF</button>
                <button onclick="clearAll()" class="bg-red-600 text-white px-6 py-3 rounded-md hover:bg-red-700 transition duration-200 shadow-md">Clear All</button>
            </div>
        </div>
    </div>

    <div id="pdfPreviewContainer" style="display: none; width: 794px; padding: 20px; background-color: white; font-family: Arial, sans-serif; box-sizing: border-box;">
    </div>

    <script>
        let services = [];
        let serviceCounter = 0;

        const companyDetails = {
            name: "Sambhav AI & TECH Services",
            website: "sambhavaintech.com",
            contact: "8600722160",
            email: "business@sambhavaintech.com",
            addressLines: ["Your Company Address Line 1, Pune", "Maharashtra, India, PIN Code"]
        };
        const companyLogoBase64 = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII="; 


        const predefinedServiceNames = [
            "Software Development", "Digital Marketing", "SEO Optimization", "AI Integration", 
            "Chatbot Integration", "Business Automation", "Mobile App Development", 
            "Website Development", "Website Maintenance", "Database Handling", 
            "Content Creation", "Social Media Handling"
        ];

        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('quotationDate').value = today;
            
            const validUntil = new Date();
            validUntil.setDate(validUntil.getDate() + 30);
            document.getElementById('validUntil').value = validUntil.toISOString().split('T')[0];
            
            document.getElementById('quotationNumber').value = 'QSAITS-' + Date.now().toString().slice(-5);
            
            if (document.getElementById('servicesContainer').children.length === 0) {
                addService();
            }

            document.addEventListener('click', function(event) {
                const openDropdowns = document.querySelectorAll('.searchable-dropdown-list');
                openDropdowns.forEach(dropdown => {
                    if (dropdown.parentElement && !dropdown.parentElement.contains(event.target)) {
                        dropdown.classList.add('hidden');
                    }
                });
            });
        });

        function addService() {
            serviceCounter++;
            const serviceDiv = document.createElement('div');
            serviceDiv.className = 'bg-gray-50 p-4 rounded-lg border border-gray-200 shadow-sm';
            serviceDiv.id = `service-${serviceCounter}`;
            
            serviceDiv.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-medium text-orange-700">Service ${serviceCounter}</h3>
                    <button onclick="removeService(${serviceCounter})" class="text-red-500 hover:text-red-700 font-bold">✕</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Service Name *</label>
                        <div class="searchable-dropdown-container">
                            <input type="text" id="serviceNameInput-${serviceCounter}" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" 
                                   oninput="filterDropdown(${serviceCounter}, this.value)" 
                                   onfocus="showDropdown(${serviceCounter})" 
                                   onchange="updateServices()"
                                   autocomplete="off" required>
                            <div id="serviceNameDropdown-${serviceCounter}" class="searchable-dropdown-list hidden"></div>
                        </div>
                        <input type="hidden" id="serviceName-${serviceCounter}" onchange="updateServices()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Payment Term *</label>
                        <select id="paymentTerm-${serviceCounter}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" onchange="updateServices()" required>
                            <option value="">Select Payment Term</option>
                            <option value="One-Time">One-Time</option>
                            <option value="Monthly">Monthly</option>
                            <option value="Yearly">Yearly</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Description *</label>
                        <textarea id="description-${serviceCounter}" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" onchange="updateServices()" required></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Cost *</label>
                        <input type="number" id="cost-${serviceCounter}" step="0.01" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" onchange="updateServices()" required>
                    </div>
                </div>
            `;
            
            document.getElementById('servicesContainer').appendChild(serviceDiv);
            populateDropdown(serviceCounter, ''); 
            updateServices(); 
        }

        function populateDropdown(id, filter) {
            const dropdownList = document.getElementById(`serviceNameDropdown-${id}`);
            if (!dropdownList) return;
            dropdownList.innerHTML = '';
            const filteredServices = predefinedServiceNames.filter(service => 
                service.toLowerCase().includes(filter.toLowerCase())
            );

            if (filteredServices.length === 0 && filter) {
                const customItem = document.createElement('div');
                customItem.className = 'searchable-dropdown-item italic text-gray-500';
                customItem.textContent = `Add "${filter}" as custom service`;
                customItem.onclick = function() { selectDropdownItem(id, filter, true); };
                dropdownList.appendChild(customItem);
            } else {
                filteredServices.forEach(serviceName => {
                    const item = document.createElement('div');
                    item.className = 'searchable-dropdown-item';
                    item.textContent = serviceName;
                    item.onclick = function() { selectDropdownItem(id, serviceName); };
                    dropdownList.appendChild(item);
                });
            }
        }

        function showDropdown(id) {
            const allDropdowns = document.querySelectorAll('.searchable-dropdown-list');
            allDropdowns.forEach(d => {
                if (d.id !== `serviceNameDropdown-${id}`) {
                    d.classList.add('hidden');
                }
            });
            const dropdownList = document.getElementById(`serviceNameDropdown-${id}`);
            if (dropdownList) {
                const currentInputVal = document.getElementById(`serviceNameInput-${id}`).value;
                populateDropdown(id, currentInputVal);
                dropdownList.classList.remove('hidden');
            }
        }

        function filterDropdown(id, filterValue) {
            const dropdownList = document.getElementById(`serviceNameDropdown-${id}`);
            if (dropdownList) {
                populateDropdown(id, filterValue);
                dropdownList.classList.remove('hidden');
            }
            const hiddenInput = document.getElementById(`serviceName-${id}`);
            if (hiddenInput) hiddenInput.value = filterValue;
        }

        function selectDropdownItem(id, value, isCustom = false) {
            const inputField = document.getElementById(`serviceNameInput-${id}`);
            const hiddenInput = document.getElementById(`serviceName-${id}`);
            const dropdownList = document.getElementById(`serviceNameDropdown-${id}`);

            if (inputField && hiddenInput) {
                inputField.value = value;
                hiddenInput.value = value;
            }
            if (dropdownList) {
                dropdownList.classList.add('hidden');
            }
            updateServices();
        }

        function removeService(id) {
            const serviceDiv = document.getElementById(`service-${id}`);
            if (serviceDiv) {
                serviceDiv.remove();
                updateServices();
            }
        }

        function updateServices() {
            services = [];
            const serviceElements = document.querySelectorAll('#servicesContainer > div[id^="service-"]'); 
            
            serviceElements.forEach(element => {
                const id = element.id.split('-')[1];
                const nameInput = document.getElementById(`serviceName-${id}`); 
                const descriptionInput = document.getElementById(`description-${id}`);
                const paymentTermInput = document.getElementById(`paymentTerm-${id}`);
                const costInput = document.getElementById(`cost-${id}`);

                if (nameInput && descriptionInput && paymentTermInput && costInput) {
                    const name = nameInput.value || '';
                    const description = descriptionInput.value || '';
                    const paymentTerm = paymentTermInput.value || '';
                    const cost = parseFloat(costInput.value || 0);
                    services.push({ id, name, description, paymentTerm, cost });
                }
            });
            
            updateTable();
            updateSummary();
        }

        function updateTable() {
            const tbody = document.getElementById('servicesTable');
            tbody.innerHTML = ''; 
            
            services.forEach(service => {
                const row = document.createElement('tr');
                row.className = "hover:bg-orange-50 transition-colors duration-150";
                row.innerHTML = `
                    <td class="border-b border-gray-200 px-4 py-2 text-sm text-gray-700">${service.name}</td>
                    <td class="border-b border-gray-200 px-4 py-2 text-sm text-gray-600">${service.description}</td>
                    <td class="border-b border-gray-200 px-4 py-2 text-sm text-gray-700">${service.paymentTerm}</td>
                    <td class="border-b border-gray-200 px-4 py-2 text-sm text-gray-700 text-right">${service.paymentTerm === 'One-Time' && service.cost > 0 ? '₹' + service.cost.toFixed(2) : '-'}</td>
                    <td class="border-b border-gray-200 px-4 py-2 text-sm text-gray-700 text-right">${service.paymentTerm === 'Monthly' && service.cost > 0 ? '₹' + service.cost.toFixed(2) : '-'}</td>
                    <td class="border-b border-gray-200 px-4 py-2 text-sm text-gray-700 text-right">${service.paymentTerm === 'Yearly' && service.cost > 0 ? '₹' + service.cost.toFixed(2) : '-'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateSummary() {
            const oneTimeServices = services.filter(s => s.paymentTerm === 'One-Time' && s.cost > 0);
            const monthlyServices = services.filter(s => s.paymentTerm === 'Monthly' && s.cost > 0);
            const yearlyServices = services.filter(s => s.paymentTerm === 'Yearly' && s.cost > 0);
            
            const oneTimeSubtotal = oneTimeServices.reduce((sum, s) => sum + s.cost, 0);
            const monthlySubtotal = monthlyServices.reduce((sum, s) => sum + s.cost, 0);
            const yearlySubtotal = yearlyServices.reduce((sum, s) => sum + s.cost, 0);
            
            const taxRate = 0.10; 
            const oneTimeTax = oneTimeSubtotal * taxRate;
            const monthlyTax = monthlySubtotal * taxRate;
            const yearlyTax = yearlySubtotal * taxRate;
            
            document.getElementById('oneTimeSubtotal').textContent = '₹' + oneTimeSubtotal.toFixed(2);
            document.getElementById('oneTimeTax').textContent = '₹' + oneTimeTax.toFixed(2);
            document.getElementById('oneTimeTotal').textContent = '₹' + (oneTimeSubtotal + oneTimeTax).toFixed(2);
            
            document.getElementById('monthlySubtotal').textContent = '₹' + monthlySubtotal.toFixed(2);
            document.getElementById('monthlyTax').textContent = '₹' + monthlyTax.toFixed(2);
            document.getElementById('monthlyTotal').textContent = '₹' + (monthlySubtotal + monthlyTax).toFixed(2);
            
            document.getElementById('yearlySubtotal').textContent = '₹' + yearlySubtotal.toFixed(2);
            document.getElementById('yearlyTax').textContent = '₹' + yearlyTax.toFixed(2);
            document.getElementById('yearlyTotal').textContent = '₹' + (yearlySubtotal + yearlyTax).toFixed(2);
        }

        function validateForm() {
            const requiredFields = [ 
                'clientName', 'clientAddress', 'clientContact',
                'quotationNumber', 'quotationDate', 'validUntil'
            ];
            
            for (let field of requiredFields) {
                const element = document.getElementById(field);
                if (!element.value.trim()) {
                    alert(`Please fill in the ${field.replace(/([A-Z])/g, ' $1').toLowerCase()} field.`);
                    element.focus();
                    return false;
                }
            }
            
            if (services.length === 0) {
                alert('Please add at least one service.');
                return false;
            }

            for (let i = 0; i < services.length; i++) {
                const service = services[i];
                const serviceNumber = service.id; 

                if (!service.name.trim()) {
                    alert(`Please enter or select a name for Service ${serviceNumber}.`);
                    document.getElementById(`serviceNameInput-${serviceNumber}`)?.focus();
                    return false;
                }
                if (!service.paymentTerm) {
                    alert(`Please select a payment term for Service ${serviceNumber}.`);
                    document.getElementById(`paymentTerm-${serviceNumber}`)?.focus();
                    return false;
                }
                if (!service.description.trim()) {
                    alert(`Please enter a description for Service ${serviceNumber}.`);
                    document.getElementById(`description-${serviceNumber}`)?.focus();
                    return false;
                }
                if (isNaN(service.cost) || service.cost <= 0) {
                    alert(`Please enter a valid cost greater than 0 for Service ${serviceNumber}.`);
                    document.getElementById(`cost-${serviceNumber}`)?.focus();
                    return false;
                }
            }
            return true;
        }

        function saveData() {
             if (!validateForm()) { 
                alert("Please complete all required fields and add valid services before saving.");
                return;
            }
            const data = {
                clientName: document.getElementById('clientName').value,
                clientAddress: document.getElementById('clientAddress').value,
                clientContact: document.getElementById('clientContact').value,
                quotationNumber: document.getElementById('quotationNumber').value,
                quotationDate: document.getElementById('quotationDate').value,
                validUntil: document.getElementById('validUntil').value,
                referenceSite: document.getElementById('referenceSite').value,
                termsConditions: document.getElementById('termsConditions').value,
                services: services.map(s => ({
                    name: s.name, 
                    description: s.description,
                    paymentTerm: s.paymentTerm,
                    cost: s.cost,
                })),
                serviceCounter: serviceCounter 
            };
            
            const dataStr = JSON.stringify(data, null, 2); 
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `quotation_${data.quotationNumber || 'data'}.json`; 
            document.body.appendChild(link); 
            link.click();
            document.body.removeChild(link); 
            URL.revokeObjectURL(url);
            
            alert('Data saved successfully as a JSON file!');
        }

        function loadData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            
                            document.getElementById('clientName').value = data.clientName || '';
                            document.getElementById('clientAddress').value = data.clientAddress || '';
                            document.getElementById('clientContact').value = data.clientContact || '';
                            document.getElementById('quotationNumber').value = data.quotationNumber || '';
                            document.getElementById('quotationDate').value = data.quotationDate || '';
                            document.getElementById('validUntil').value = data.validUntil || '';
                            document.getElementById('referenceSite').value = data.referenceSite || '';
                            document.getElementById('termsConditions').value = data.termsConditions || '';
                            
                            serviceCounter = 0; 
                            document.getElementById('servicesContainer').innerHTML = ''; 
                            services = []; 

                            if (data.services && Array.isArray(data.services)) {
                                data.services.forEach(loadedService => {
                                    addService(); 
                                    const currentId = serviceCounter; 

                                    const serviceNameInput = document.getElementById(`serviceNameInput-${currentId}`);
                                    const serviceNameHidden = document.getElementById(`serviceName-${currentId}`);
                                    if (serviceNameInput) serviceNameInput.value = loadedService.name;
                                    if (serviceNameHidden) serviceNameHidden.value = loadedService.name;
                                    
                                    const descriptionInput = document.getElementById(`description-${currentId}`);
                                    if (descriptionInput) descriptionInput.value = loadedService.description;
                                    
                                    const paymentTermInput = document.getElementById(`paymentTerm-${currentId}`);
                                    if (paymentTermInput) paymentTermInput.value = loadedService.paymentTerm;
                                    
                                    const costInput = document.getElementById(`cost-${currentId}`);
                                    if (costInput) costInput.value = loadedService.cost;
                                });
                            }
                            
                            updateServices(); 
                            alert('Data loaded successfully!');
                        } catch (error) {
                            console.error('Error loading data:', error);
                            alert('Error loading data: ' + error.message + '. Please ensure it is a valid quotation JSON file.');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function clearAll() {
            if (confirm('Are you sure you want to clear all data? This action cannot be undone.')) {
                const formElements = document.querySelectorAll(
                    '#clientName, #clientContact, #clientAddress, #referenceSite, #termsConditions, input[type="number"]'
                );
                formElements.forEach(element => {
                    element.value = '';
                });
                
                document.getElementById('servicesContainer').innerHTML = '';
                services = [];
                serviceCounter = 0; 
                
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('quotationDate').value = today;
                const validUntil = new Date();
                validUntil.setDate(validUntil.getDate() + 30);
                document.getElementById('validUntil').value = validUntil.toISOString().split('T')[0];
                document.getElementById('quotationNumber').value = 'QSAITS-' + Date.now().toString().slice(-5);
                
                document.getElementById('termsConditions').value = `1. Payment Terms: Payment is due within 30 days of invoice date.
2. Scope of Work: This quotation covers the services outlined above. Any additional work will be quoted separately.
3. Validity: This quotation is valid for 30 days from the date mentioned above.
4. Cancellation: Either party may cancel this agreement with 30 days written notice for recurring services.
5. Intellectual Property: Upon full payment for custom development (one-time services), intellectual property rights for the deliverables will transfer to the client, unless otherwise specified for licensed software/platforms or ongoing services.
6. Liability: Our liability is limited to the total value of this contract for the specific service in question.
7. Force Majeure: Neither party shall be liable for delays due to circumstances beyond their control.
8. Governing Law: This agreement shall be governed by the laws of [Your Jurisdiction, e.g., India].`;
                
                addService(); 
                updateTable();
                updateSummary();
                alert('All data cleared.');
            }
        }

        async function buildPdfPreviewHTML() {
            const previewContainer = document.getElementById('pdfPreviewContainer');
            previewContainer.innerHTML = ''; 

            const themeOrangeHex = "#F97316";
            const themeDarkOrangeHex = "#EA580C";
            const themeBlackHex = "#111827";
            const themeGrayHex = "#374151";
            const themeLightGrayHex = "#E5E7EB";
            const themeTableBorderHex = "#D1D5DB"; // gray-300 for table borders

            let htmlContent = `<div style="color: ${themeBlackHex}; font-size: 9pt; line-height: 1.4;">`; // Base font size and line height

            htmlContent += `
                <table style="width: 100%; margin-bottom: 10mm;">
                    <tr>
                        <td style="width: 65%; vertical-align: top;">
                            <img src="${companyLogoBase64}" alt="${companyDetails.name} Logo" style="width: 55mm; height: auto; display: block; margin-bottom: 5mm;">
                        </td>
                        <td style="width: 35%; text-align: right; vertical-align: top;">
                            <h1 style="font-size: 20pt; color: ${themeOrangeHex}; font-weight: bold; margin: 0;">QUOTATION</h1>
                        </td>
                    </tr>
                </table>`;
            
            const clientNameVal = document.getElementById('clientName').value || "Valued Client";
            htmlContent += `
                <div style="margin-bottom: 7mm;">
                    <p>Dear ${clientNameVal},</p>
                    <p style="margin-top: 3mm;">We are pleased to provide you with the following quotation for our services. We are confident that our solutions can significantly benefit your business objectives.</p>
                </div>`;

            htmlContent += `
                <table style="width: 100%; margin-bottom: 7mm; font-size: 8pt; border-collapse: collapse;">
                    <tr>
                        <td style="width: 50%; vertical-align: top; padding-right: 5mm; box-sizing: border-box;">
                            <strong style="color: ${themeGrayHex}; display: block; margin-bottom: 1mm;">FROM:</strong>
                            ${companyDetails.name}<br>
                            ${companyDetails.addressLines.join('<br>')}<br>
                            Website: ${companyDetails.website}<br>
                            Contact: ${companyDetails.contact}<br>
                            Email: ${companyDetails.email}
                        </td>
                        <td style="width: 50%; vertical-align: top; padding-left: 5mm; box-sizing: border-box;">
                            <strong style="color: ${themeGrayHex};">Quotation #:</strong> ${document.getElementById('quotationNumber').value}<br>
                            <strong style="color: ${themeGrayHex};">Date:</strong> ${document.getElementById('quotationDate').value}<br>
                            <strong style="color: ${themeGrayHex};">Valid Until:</strong> ${document.getElementById('validUntil').value}<br>
                            ${document.getElementById('referenceSite').value ? `<strong style="color: ${themeGrayHex};">Reference:</strong> ${document.getElementById('referenceSite').value}<br>` : ''}
                            <br> 
                            <strong style="color: ${themeGrayHex}; display: block; margin-bottom: 1mm;">TO:</strong>
                            ${clientNameVal}<br>
                            ${document.getElementById('clientAddress').value.replace(/\n/g, '<br>')}<br>
                            ${document.getElementById('clientContact').value}
                        </td>
                    </tr>
                </table>`;

            htmlContent += `
                <h2 style="font-size: 11pt; color: ${themeDarkOrangeHex}; font-weight: bold; margin-top: 7mm; margin-bottom: 3mm; border-bottom: 1px solid ${themeLightGrayHex}; padding-bottom: 1mm;">SERVICES PROPOSED</h2>
                <table style="width: 100%; border-collapse: collapse; font-size: 8pt;">
                    <thead>
                        <tr style="background-color: ${themeBlackHex}; color: white;">
                            <th style="border: 1px solid ${themeTableBorderHex}; padding: 2mm; text-align: left;">Service</th>
                            <th style="border: 1px solid ${themeTableBorderHex}; padding: 2mm; text-align: left;">Description</th>
                            <th style="border: 1px solid ${themeTableBorderHex}; padding: 2mm; text-align: left;">Term</th>
                            <th style="border: 1px solid ${themeTableBorderHex}; padding: 2mm; text-align: right;">Cost</th>
                        </tr>
                    </thead>
                    <tbody>`;
            services.forEach((service, index) => {
                htmlContent += `
                        <tr style="${index % 2 !== 0 ? `background-color: #f9fafb;` : ''}">
                            <td style="border: 1px solid ${themeTableBorderHex}; padding: 2mm; vertical-align: top;">${service.name}</td>
                            <td style="border: 1px solid ${themeTableBorderHex}; padding: 2mm; vertical-align: top;">${service.description}</td>
                            <td style="border: 1px solid ${themeTableBorderHex}; padding: 2mm; vertical-align: top;">${service.paymentTerm}</td>
                            <td style="border: 1px solid ${themeTableBorderHex}; padding: 2mm; text-align: right; vertical-align: top;">${service.cost > 0 ? '₹' + service.cost.toFixed(2) : '-'}</td>
                        </tr>`;
            });
            htmlContent += `
                    </tbody>
                </table>`;
            
            htmlContent += `<h2 style="font-size: 11pt; color: ${themeDarkOrangeHex}; font-weight: bold; margin-top: 7mm; margin-bottom: 3mm; border-bottom: 1px solid ${themeLightGrayHex}; padding-bottom: 1mm;">INVESTMENT SUMMARY</h2>`;
            
            function addSummarySectionHTML(title, term) {
                const filteredServices = services.filter(s => s.paymentTerm === term && s.cost > 0);
                if (filteredServices.length > 0) {
                    const subtotal = filteredServices.reduce((sum, s) => sum + s.cost, 0);
                    const tax = subtotal * 0.10; 
                    const total = subtotal + tax;
                    htmlContent += `
                        <div style="margin-bottom: 5mm; font-size: 9pt; overflow: auto;">
                            <div style="float: left; font-weight: bold; color: ${themeBlackHex};">${title}</div>
                            <div style="float: right; text-align: right; width: 100mm;">
                                <table style="width: 100%; text-align: right;">
                                    <tr><td style="color: ${themeGrayHex}; padding-right: 2mm;">Subtotal:</td><td>₹${subtotal.toFixed(2)}</td></tr>
                                    <tr><td style="color: ${themeGrayHex}; padding-right: 2mm;">Tax (10%):</td><td>₹${tax.toFixed(2)}</td></tr>
                                    <tr><td colspan="2" style="border-top: 1px solid ${themeLightGrayHex}; padding-top: 1mm; margin-top: 1mm;"></td></tr>
                                    <tr><td style="font-weight: bold; padding-right: 2mm;">Total:</td><td style="font-weight: bold;">₹${total.toFixed(2)}</td></tr>
                                </table>
                            </div>
                            <div style="clear: both;"></div>
                        </div>`;
                }
            }
            addSummarySectionHTML('One-Time Investment:', 'One-Time');
            addSummarySectionHTML('Monthly Recurring Investment:', 'Monthly');
            addSummarySectionHTML('Yearly Recurring Investment:', 'Yearly');

            htmlContent += `
                <h2 style="font-size: 11pt; color: ${themeDarkOrangeHex}; font-weight: bold; margin-top: 7mm; margin-bottom: 3mm; border-bottom: 1px solid ${themeLightGrayHex}; padding-bottom: 1mm;">TERMS AND CONDITIONS</h2>
                <div style="font-size: 8pt; color: ${themeGrayHex}; white-space: pre-wrap;">${document.getElementById('termsConditions').value}</div>`;
            
            htmlContent += `
                <div style="margin-top: 10mm; font-size: 9pt;">
                    <p>Thank you for the opportunity to provide this quotation. We look forward to partnering with you.</p>
                    <p style="margin-top: 3mm;">Sincerely,</p>
                    <div style="margin-top: 3mm; margin-bottom: 1mm;">
                         <img src="${companyLogoBase64}" alt="${companyDetails.name} Logo" style="width: 35mm; height: auto; display: block;">
                    </div>
                    <p style="font-weight: bold; margin-top:0;">${companyDetails.name}</p>
                </div>`;

            htmlContent += `
                <table style="width: 100%; margin-top: 15mm; font-size: 9pt; border-spacing: 0 10mm;">
                    <tr>
                        <td style="width: 50%; padding-right: 5mm; vertical-align: bottom;">
                            Accepted By (Company):<br>
                            <div style="border-bottom: 1px solid ${themeBlackHex}; height: 15mm; margin-top: 2mm;"></div>
                            Date:
                            <div style="border-bottom: 1px solid ${themeBlackHex}; height: 7mm; margin-top: 2mm; display: inline-block; width: 30mm; margin-left: 2mm;"></div>
                        </td>
                        <td style="width: 50%; padding-left: 5mm; vertical-align: bottom;">
                            Accepted By (Client):<br>
                            <div style="border-bottom: 1px solid ${themeBlackHex}; height: 15mm; margin-top: 2mm;"></div>
                            Date:
                            <div style="border-bottom: 1px solid ${themeBlackHex}; height: 7mm; margin-top: 2mm; display: inline-block; width: 30mm; margin-left: 2mm;"></div>
                        </td>
                    </tr>
                </table>`;
            
            htmlContent += `</div>`;
            previewContainer.innerHTML = htmlContent;
            // Add page number placeholder, to be filled by jsPDF loop
            previewContainer.dataset.pageNumber = "{pageNum}";
            previewContainer.dataset.totalPages = "{totalPages}";

        }


        async function generatePDF() {
            if (!validateForm()) {
                return;
            }

            await buildPdfPreviewHTML(); 

            const { jsPDF } = window.jspdf;
            const elementToCapture = document.getElementById('pdfPreviewContainer');
            
            elementToCapture.style.display = 'block';
            elementToCapture.style.position = 'absolute';
            elementToCapture.style.left = '-9999px'; // Move off-screen
            elementToCapture.style.top = '-9999px';
            
            try {
                const canvas = await html2canvas(elementToCapture, {
                    scale: 2.5, 
                    useCORS: true, 
                    backgroundColor: '#ffffff',
                    logging: false, 
                    width: elementToCapture.offsetWidth, // Use offsetWidth for more accurate width
                    height: elementToCapture.scrollHeight,
                    windowWidth: elementToCapture.scrollWidth,
                    windowHeight: elementToCapture.scrollHeight
                });
                
                elementToCapture.style.display = 'none';
                elementToCapture.style.position = 'static';


                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4'); 
                
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                
                const canvasWidthPx = canvas.width;
                const canvasHeightPx = canvas.height;

                // Calculate image height in mm to maintain aspect ratio based on PDF width
                const imgHeightMM = (canvasHeightPx * pdfWidth) / canvasWidthPx;
                
                let heightLeft = imgHeightMM;
                let position = 0; 
                let pageNumber = 1;

                // Estimate total pages for footer
                const totalPages = Math.ceil(imgHeightMM / pdfHeight);

                function addFooter(pdfInstance, currentPage, totalPagesNum) {
                    pdfInstance.setFontSize(8);
                    pdfInstance.setTextColor(100); // Gray color
                    const footerY = pdfHeight - 10;
                    pdfInstance.text(companyDetails.name, 15, footerY, { align: 'left' });
                    pdfInstance.text(`Page ${currentPage} of ${totalPagesNum}`, pdfWidth - 15, footerY, { align: 'right' });
                }

                addFooter(pdf, pageNumber, totalPages);
                pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeightMM);
                heightLeft -= pdfHeight;
                
                while (heightLeft > 0.1) { // Use a small threshold to avoid float precision issues
                    position -= pdfHeight; 
                    pageNumber++;
                    pdf.addPage();
                    addFooter(pdf, pageNumber, totalPages);
                    pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeightMM);
                    heightLeft -= pdfHeight;
                }
                
                const clientNameForFile = document.getElementById('clientName').value.replace(/\s+/g, '_') || 'Client';
                const quoteNumForFile = document.getElementById('quotationNumber').value || 'Quote';
                pdf.save(`Quotation_${quoteNumForFile}_${clientNameForFile}.pdf`);

            } catch (error) {
                console.error('Error generating PDF with html2canvas:', error);
                alert('Error generating PDF. Please check the console for details and try again.');
                elementToCapture.style.display = 'none';
                elementToCapture.style.position = 'static';

            }
        }
    </script>
</body>
</html>
