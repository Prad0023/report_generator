<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale-1.0">
    <title>Quotation Generator - Sambhav AI & TECH Services</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* Custom scrollbar for webkit browsers */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #F97316; /* Orange-500 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #EA580C; /* Orange-600 */
        }
        .searchable-dropdown-container {
            position: relative;
        }
        .searchable-dropdown-list {
            position: absolute;
            background-color: white;
            border: 1px solid #e5e7eb; /* gray-200 */
            border-top: none;
            z-index: 10;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-radius: 0 0 0.375rem 0.375rem; /* rounded-b-md */
        }
        .searchable-dropdown-item {
            padding: 0.5rem 0.75rem; /* py-2 px-3 */
            cursor: pointer;
        }
        .searchable-dropdown-item:hover {
            background-color: #FFF7ED; /* orange-50 */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <div class="bg-white rounded-lg shadow-xl p-6 sm:p-8">
            <div class="text-center mb-8">
                <img src="https://prad0023.github.io/report_generator/sambhav_logo.png" alt="Sambhav AI & TECH Services Logo" id="companyLogoDisplay" class="mx-auto h-16 sm:h-20 mb-4">
                <h1 class="text-3xl font-bold text-orange-600">Quotation Generator</h1>
                <p class="text-sm text-gray-600">Sambhav AI & TECH Services</p>
            </div>
            
            <div class="mb-8 p-4 border border-orange-200 rounded-lg bg-orange-50">
                <h2 class="text-xl font-semibold text-orange-700 mb-3">Company Information</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2 text-sm text-gray-700">
                    <div><strong>Name:</strong> Sambhav AI & TECH Services</div>
                    <div><strong>Website:</strong> <a href="https://sambhavaintech.com" target="_blank" class="text-orange-600 hover:text-orange-700 underline">sambhavaintech.com</a></div>
                    <div><strong>Contact:</strong> 8600722160</div>
                    <div><strong>Email:</strong> <a href="mailto:business@sambhavaintech.com" class="text-orange-600 hover:text-orange-700 underline">business@sambhavaintech.com</a></div>
                </div>
            </div>

            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Client Information</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Client Name *</label>
                        <input type="text" id="clientName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Client Contact *</label>
                        <input type="text" id="clientContact" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" required>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Client Address *</label>
                        <textarea id="clientAddress" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" required></textarea>
                    </div>
                </div>
            </div>

            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Quotation Details</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Quotation Number *</label>
                        <input type="text" id="quotationNumber" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Date *</label>
                        <input type="date" id="quotationDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Valid Until *</label>
                        <input type="date" id="validUntil" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" required>
                    </div>
                    <div class="md:col-span-3">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Reference Site (Optional)</label>
                        <input type="url" id="referenceSite" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="https://example.com">
                    </div>
                </div>
            </div>

            <div class="mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">Services</h2>
                    <button onclick="addService()" class="bg-orange-500 text-white px-4 py-2 rounded-md hover:bg-orange-600 transition duration-200 shadow-md">+ Add Service</button>
                </div>
                <div id="servicesContainer" class="space-y-4">
                    {/* Services will be added here */}
                </div>
            </div>

            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Services Overview</h2>
                <div class="overflow-x-auto rounded-lg border border-gray-200">
                    <table class="w-full">
                        <thead class="bg-gray-700 text-white">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Service Name</th>
                                <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Description</th>
                                <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Payment Term</th>
                                <th class="px-4 py-3 text-right text-xs font-medium uppercase tracking-wider">One-Time Cost</th>
                                <th class="px-4 py-3 text-right text-xs font-medium uppercase tracking-wider">Monthly Cost</th>
                                <th class="px-4 py-3 text-right text-xs font-medium uppercase tracking-wider">Yearly Cost</th>
                            </tr>
                        </thead>
                        <tbody id="servicesTable" class="bg-white divide-y divide-gray-200">
                            {/* Table rows will be populated dynamically */}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Cost Summary</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-orange-50 p-4 rounded-lg shadow">
                        <h3 class="font-semibold text-orange-700 mb-2">One-Time Payment</h3>
                        <div class="space-y-1 text-sm text-gray-700">
                            <div class="flex justify-between"><span>Subtotal:</span><span id="oneTimeSubtotal">$0.00</span></div>
                            <div class="flex justify-between"><span>Tax (10%):</span><span id="oneTimeTax">$0.00</span></div>
                            <div class="flex justify-between font-bold text-gray-800 border-t border-orange-200 pt-1 mt-1"><span>Total:</span><span id="oneTimeTotal">$0.00</span></div>
                        </div>
                    </div>
                    <div class="bg-orange-50 p-4 rounded-lg shadow">
                        <h3 class="font-semibold text-orange-700 mb-2">Monthly Payment</h3>
                        <div class="space-y-1 text-sm text-gray-700">
                            <div class="flex justify-between"><span>Subtotal:</span><span id="monthlySubtotal">$0.00</span></div>
                            <div class="flex justify-between"><span>Tax (10%):</span><span id="monthlyTax">$0.00</span></div>
                            <div class="flex justify-between font-bold text-gray-800 border-t border-orange-200 pt-1 mt-1"><span>Total:</span><span id="monthlyTotal">$0.00</span></div>
                        </div>
                    </div>
                    <div class="bg-orange-50 p-4 rounded-lg shadow">
                        <h3 class="font-semibold text-orange-700 mb-2">Yearly Payment</h3>
                        <div class="space-y-1 text-sm text-gray-700">
                            <div class="flex justify-between"><span>Subtotal:</span><span id="yearlySubtotal">$0.00</span></div>
                            <div class="flex justify-between"><span>Tax (10%):</span><span id="yearlyTax">$0.00</span></div>
                            <div class="flex justify-between font-bold text-gray-800 border-t border-orange-200 pt-1 mt-1"><span>Total:</span><span id="yearlyTotal">$0.00</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Terms and Conditions</h2>
                <textarea id="termsConditions" rows="8" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500 text-sm">1. Payment Terms: Payment is due within 30 days of invoice date.
2. Scope of Work: This quotation covers the services outlined above. Any additional work will be quoted separately.
3. Validity: This quotation is valid for 30 days from the date mentioned above.
4. Cancellation: Either party may cancel this agreement with 30 days written notice for recurring services.
5. Intellectual Property: Upon full payment for custom development (one-time services), intellectual property rights for the deliverables will transfer to the client, unless otherwise specified for licensed software/platforms or ongoing services.
6. Liability: Our liability is limited to the total value of this contract for the specific service in question.
7. Force Majeure: Neither party shall be liable for delays due to circumstances beyond their control.
8. Governing Law: This agreement shall be governed by the laws of [Your Jurisdiction, e.g., India].</textarea>
            </div>

            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <button onclick="saveData()" class="bg-gray-700 text-white px-6 py-3 rounded-md hover:bg-black transition duration-200 shadow-md">Save Data</button>
                <button onclick="loadData()" class="bg-gray-700 text-white px-6 py-3 rounded-md hover:bg-black transition duration-200 shadow-md">Load Saved Data</button>
                <button onclick="generatePDF()" class="bg-orange-500 text-white px-6 py-3 rounded-md hover:bg-orange-600 transition duration-200 shadow-md font-semibold">Download PDF</button>
                <button onclick="clearAll()" class="bg-red-600 text-white px-6 py-3 rounded-md hover:bg-red-700 transition duration-200 shadow-md">Clear All</button>
            </div>
        </div>
    </div>

    <script>
        let services = [];
        let serviceCounter = 0;

        const companyDetails = {
            name: "Sambhav AI & TECH Services",
            website: "sambhavaintech.com",
            contact: "8600722160",
            email: "business@sambhavaintech.com",
            addressLines: ["Your Company Address Line 1, Pune", "Maharashtra, India, PIN Code"]
        };
        const companyLogoBase64 = "YOUR_LOGO_BASE64_STRING_HERE"; 

        const predefinedServiceNames = [
            "Software Development", "Digital Marketing", "SEO Optimization", "AI Integration", 
            "Chatbot Integration", "Business Automation", "Mobile App Development", 
            "Website Development", "Website Maintenance", "Database Handling", 
            "Content Creation", "Social Media Handling"
        ];

        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('quotationDate').value = today;
            
            const validUntil = new Date();
            validUntil.setDate(validUntil.getDate() + 30);
            document.getElementById('validUntil').value = validUntil.toISOString().split('T')[0];
            
            document.getElementById('quotationNumber').value = 'QSAITS-' + Date.now().toString().slice(-5);
            
            if (companyLogoBase64 && companyLogoBase64 !== "YOUR_LOGO_BASE64_STRING_HERE" && document.getElementById('companyLogoDisplay')) {
                // document.getElementById('companyLogoDisplay').src = companyLogoBase64; 
            }
            
            if (document.getElementById('servicesContainer').children.length === 0) {
                addService();
            }

            // Close dropdown if clicked outside
            document.addEventListener('click', function(event) {
                const openDropdowns = document.querySelectorAll('.searchable-dropdown-list');
                openDropdowns.forEach(dropdown => {
                    if (!dropdown.parentElement.contains(event.target)) {
                        dropdown.classList.add('hidden');
                    }
                });
            });
        });

        function addService() {
            serviceCounter++;
            const serviceDiv = document.createElement('div');
            serviceDiv.className = 'bg-gray-50 p-4 rounded-lg border border-gray-200 shadow-sm';
            serviceDiv.id = `service-${serviceCounter}`;
            
            serviceDiv.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-medium text-orange-700">Service ${serviceCounter}</h3>
                    <button onclick="removeService(${serviceCounter})" class="text-red-500 hover:text-red-700 font-bold">✕</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Service Name *</label>
                        <div class="searchable-dropdown-container">
                            <input type="text" id="serviceNameInput-${serviceCounter}" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" 
                                   oninput="filterDropdown(${serviceCounter}, this.value)" 
                                   onfocus="showDropdown(${serviceCounter})" 
                                   onchange="updateServices()"
                                   autocomplete="off" required>
                            <div id="serviceNameDropdown-${serviceCounter}" class="searchable-dropdown-list hidden">
                                <!-- Dropdown items will be populated here -->
                            </div>
                        </div>
                        <input type="hidden" id="serviceName-${serviceCounter}" onchange="updateServices()"> {/* Hidden input to store final value */}
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Payment Term *</label>
                        <select id="paymentTerm-${serviceCounter}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" onchange="updateServices()" required>
                            <option value="">Select Payment Term</option>
                            <option value="One-Time">One-Time</option>
                            <option value="Monthly">Monthly</option>
                            <option value="Yearly">Yearly</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Description *</label>
                        <textarea id="description-${serviceCounter}" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" onchange="updateServices()" required></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Cost *</label>
                        <input type="number" id="cost-${serviceCounter}" step="0.01" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" onchange="updateServices()" required>
                    </div>
                </div>
            `;
            
            document.getElementById('servicesContainer').appendChild(serviceDiv);
            populateDropdown(serviceCounter, ''); // Populate with all items initially
            updateServices(); 
        }

        function populateDropdown(id, filter) {
            const dropdownList = document.getElementById(`serviceNameDropdown-${id}`);
            if (!dropdownList) return;
            dropdownList.innerHTML = ''; // Clear existing items
            const filteredServices = predefinedServiceNames.filter(service => 
                service.toLowerCase().includes(filter.toLowerCase())
            );

            if (filteredServices.length === 0 && filter) {
                // Option to add custom service if not in list
                const customItem = document.createElement('div');
                customItem.className = 'searchable-dropdown-item italic text-gray-500';
                customItem.textContent = `Add "${filter}" as custom service`;
                customItem.onclick = function() { selectDropdownItem(id, filter, true); };
                dropdownList.appendChild(customItem);
            } else {
                filteredServices.forEach(serviceName => {
                    const item = document.createElement('div');
                    item.className = 'searchable-dropdown-item';
                    item.textContent = serviceName;
                    item.onclick = function() { selectDropdownItem(id, serviceName); };
                    dropdownList.appendChild(item);
                });
            }
        }

        function showDropdown(id) {
            // Close other dropdowns first
            const allDropdowns = document.querySelectorAll('.searchable-dropdown-list');
            allDropdowns.forEach(d => {
                if (d.id !== `serviceNameDropdown-${id}`) {
                    d.classList.add('hidden');
                }
            });
            const dropdownList = document.getElementById(`serviceNameDropdown-${id}`);
            if (dropdownList) {
                 // Repopulate if empty or based on current input value if user re-focuses
                const currentInputVal = document.getElementById(`serviceNameInput-${id}`).value;
                populateDropdown(id, currentInputVal);
                dropdownList.classList.remove('hidden');
            }
        }

        function filterDropdown(id, filterValue) {
            const dropdownList = document.getElementById(`serviceNameDropdown-${id}`);
            if (dropdownList) {
                populateDropdown(id, filterValue);
                dropdownList.classList.remove('hidden'); // Ensure it's visible while typing
            }
            // Update the hidden input as the user types for custom entries
            const hiddenInput = document.getElementById(`serviceName-${id}`);
            if (hiddenInput) hiddenInput.value = filterValue;
            // No immediate updateServices() here, will be called on blur/change of the input or selection
        }

        function selectDropdownItem(id, value, isCustom = false) {
            const inputField = document.getElementById(`serviceNameInput-${id}`);
            const hiddenInput = document.getElementById(`serviceName-${id}`); // The actual field for data
            const dropdownList = document.getElementById(`serviceNameDropdown-${id}`);

            if (inputField && hiddenInput) {
                inputField.value = value; // Set visible input
                hiddenInput.value = value; // Set hidden input that is used by updateServices
            }
            if (dropdownList) {
                dropdownList.classList.add('hidden');
            }
            updateServices(); // Update the main services array and table
        }


        function removeService(id) {
            const serviceDiv = document.getElementById(`service-${id}`);
            if (serviceDiv) {
                serviceDiv.remove();
                updateServices();
            }
        }

        function updateServices() {
            services = [];
            const serviceElements = document.querySelectorAll('#servicesContainer > div[id^="service-"]'); 
            
            serviceElements.forEach(element => {
                const id = element.id.split('-')[1];
                // Use the hidden input for serviceName now
                const nameInput = document.getElementById(`serviceName-${id}`); 
                const descriptionInput = document.getElementById(`description-${id}`);
                const paymentTermInput = document.getElementById(`paymentTerm-${id}`);
                const costInput = document.getElementById(`cost-${id}`);

                if (nameInput && descriptionInput && paymentTermInput && costInput) {
                    const name = nameInput.value || ''; // Get value from hidden input
                    const description = descriptionInput.value || '';
                    const paymentTerm = paymentTermInput.value || '';
                    const cost = parseFloat(costInput.value || 0);
                    services.push({ id, name, description, paymentTerm, cost });
                }
            });
            
            updateTable();
            updateSummary();
        }

        function updateTable() {
            const tbody = document.getElementById('servicesTable');
            tbody.innerHTML = ''; 
            
            services.forEach(service => {
                const row = document.createElement('tr');
                row.className = "hover:bg-orange-50 transition-colors duration-150";
                row.innerHTML = `
                    <td class="border-b border-gray-200 px-4 py-2 text-sm text-gray-700">${service.name}</td>
                    <td class="border-b border-gray-200 px-4 py-2 text-sm text-gray-600">${service.description}</td>
                    <td class="border-b border-gray-200 px-4 py-2 text-sm text-gray-700">${service.paymentTerm}</td>
                    <td class="border-b border-gray-200 px-4 py-2 text-sm text-gray-700 text-right">${service.paymentTerm === 'One-Time' && service.cost > 0 ? '$' + service.cost.toFixed(2) : '-'}</td>
                    <td class="border-b border-gray-200 px-4 py-2 text-sm text-gray-700 text-right">${service.paymentTerm === 'Monthly' && service.cost > 0 ? '$' + service.cost.toFixed(2) : '-'}</td>
                    <td class="border-b border-gray-200 px-4 py-2 text-sm text-gray-700 text-right">${service.paymentTerm === 'Yearly' && service.cost > 0 ? '$' + service.cost.toFixed(2) : '-'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateSummary() {
            const oneTimeServices = services.filter(s => s.paymentTerm === 'One-Time' && s.cost > 0);
            const monthlyServices = services.filter(s => s.paymentTerm === 'Monthly' && s.cost > 0);
            const yearlyServices = services.filter(s => s.paymentTerm === 'Yearly' && s.cost > 0);
            
            const oneTimeSubtotal = oneTimeServices.reduce((sum, s) => sum + s.cost, 0);
            const monthlySubtotal = monthlyServices.reduce((sum, s) => sum + s.cost, 0);
            const yearlySubtotal = yearlyServices.reduce((sum, s) => sum + s.cost, 0);
            
            const taxRate = 0.10; 
            const oneTimeTax = oneTimeSubtotal * taxRate;
            const monthlyTax = monthlySubtotal * taxRate;
            const yearlyTax = yearlySubtotal * taxRate;
            
            document.getElementById('oneTimeSubtotal').textContent = '$' + oneTimeSubtotal.toFixed(2);
            document.getElementById('oneTimeTax').textContent = '$' + oneTimeTax.toFixed(2);
            document.getElementById('oneTimeTotal').textContent = '$' + (oneTimeSubtotal + oneTimeTax).toFixed(2);
            
            document.getElementById('monthlySubtotal').textContent = '$' + monthlySubtotal.toFixed(2);
            document.getElementById('monthlyTax').textContent = '$' + monthlyTax.toFixed(2);
            document.getElementById('monthlyTotal').textContent = '$' + (monthlySubtotal + monthlyTax).toFixed(2);
            
            document.getElementById('yearlySubtotal').textContent = '$' + yearlySubtotal.toFixed(2);
            document.getElementById('yearlyTax').textContent = '$' + yearlyTax.toFixed(2);
            document.getElementById('yearlyTotal').textContent = '$' + (yearlySubtotal + yearlyTax).toFixed(2);
        }

        function validateForm() {
            const requiredFields = [ 
                'clientName', 'clientAddress', 'clientContact',
                'quotationNumber', 'quotationDate', 'validUntil'
            ];
            
            for (let field of requiredFields) {
                const element = document.getElementById(field);
                if (!element.value.trim()) {
                    alert(`Please fill in the ${field.replace(/([A-Z])/g, ' $1').toLowerCase()} field.`);
                    element.focus();
                    return false;
                }
            }
            
            if (services.length === 0) {
                alert('Please add at least one service.');
                return false;
            }

            for (let i = 0; i < services.length; i++) {
                const service = services[i];
                const serviceNumber = service.id; 

                if (!service.name.trim()) {
                    alert(`Please enter or select a name for Service ${serviceNumber}.`);
                    document.getElementById(`serviceNameInput-${serviceNumber}`)?.focus(); // Focus the visible input
                    return false;
                }
                // ... (rest of service validation remains the same)
                if (!service.paymentTerm) {
                    alert(`Please select a payment term for Service ${serviceNumber}.`);
                    document.getElementById(`paymentTerm-${serviceNumber}`)?.focus();
                    return false;
                }
                if (!service.description.trim()) {
                    alert(`Please enter a description for Service ${serviceNumber}.`);
                    document.getElementById(`description-${serviceNumber}`)?.focus();
                    return false;
                }
                if (isNaN(service.cost) || service.cost <= 0) {
                    alert(`Please enter a valid cost greater than 0 for Service ${serviceNumber}.`);
                    document.getElementById(`cost-${serviceNumber}`)?.focus();
                    return false;
                }
            }
            return true;
        }

        function saveData() {
            if (!validateForm()) { 
                alert("Please complete all required fields and add valid services before saving.");
                return;
            }
            const data = {
                clientName: document.getElementById('clientName').value,
                clientAddress: document.getElementById('clientAddress').value,
                clientContact: document.getElementById('clientContact').value,
                quotationNumber: document.getElementById('quotationNumber').value,
                quotationDate: document.getElementById('quotationDate').value,
                validUntil: document.getElementById('validUntil').value,
                referenceSite: document.getElementById('referenceSite').value,
                termsConditions: document.getElementById('termsConditions').value,
                services: services.map(s => ({ // Save the selected/typed service name
                    name: s.name, // This now comes from the hidden input correctly
                    description: s.description,
                    paymentTerm: s.paymentTerm,
                    cost: s.cost,
                    // id: s.id // ID is mainly for DOM manipulation, not strictly needed in saved data unless for precise re-rendering
                })),
                serviceCounter: serviceCounter 
            };
            
            // We don't need to save servicesHTML if we rebuild from the `services` array on load.
            // However, if you prefer to save HTML for exact form state restoration including dropdown inputs:
            // const servicesContainer = document.getElementById('servicesContainer');
            // data.servicesHTML = servicesContainer.innerHTML; 
            
            const dataStr = JSON.stringify(data, null, 2); 
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `quotation_${data.quotationNumber || 'data'}.json`; 
            document.body.appendChild(link); 
            link.click();
            document.body.removeChild(link); 
            URL.revokeObjectURL(url);
            
            alert('Data saved successfully as a JSON file!');
        }

        function loadData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            
                            document.getElementById('clientName').value = data.clientName || '';
                            document.getElementById('clientAddress').value = data.clientAddress || '';
                            document.getElementById('clientContact').value = data.clientContact || '';
                            document.getElementById('quotationNumber').value = data.quotationNumber || '';
                            document.getElementById('quotationDate').value = data.quotationDate || '';
                            document.getElementById('validUntil').value = data.validUntil || '';
                            document.getElementById('referenceSite').value = data.referenceSite || '';
                            document.getElementById('termsConditions').value = data.termsConditions || '';
                            
                            serviceCounter = 0; // Reset before rebuilding
                            document.getElementById('servicesContainer').innerHTML = ''; // Clear existing services
                            services = []; // Clear internal services array

                            if (data.services && Array.isArray(data.services)) {
                                data.services.forEach(loadedService => {
                                    addService(); // This increments serviceCounter and creates new elements
                                    const currentId = serviceCounter; // Get the ID of the newly added service

                                    // Populate the fields of the newly added service
                                    const serviceNameInput = document.getElementById(`serviceNameInput-${currentId}`);
                                    const serviceNameHidden = document.getElementById(`serviceName-${currentId}`);
                                    if (serviceNameInput) serviceNameInput.value = loadedService.name;
                                    if (serviceNameHidden) serviceNameHidden.value = loadedService.name;
                                    
                                    const descriptionInput = document.getElementById(`description-${currentId}`);
                                    if (descriptionInput) descriptionInput.value = loadedService.description;
                                    
                                    const paymentTermInput = document.getElementById(`paymentTerm-${currentId}`);
                                    if (paymentTermInput) paymentTermInput.value = loadedService.paymentTerm;
                                    
                                    const costInput = document.getElementById(`cost-${currentId}`);
                                    if (costInput) costInput.value = loadedService.cost;
                                });
                            }
                            
                            updateServices(); // Sync internal array and UI tables/summary
                            alert('Data loaded successfully!');
                        } catch (error) {
                            console.error('Error loading data:', error);
                            alert('Error loading data: ' + error.message + '. Please ensure it is a valid quotation JSON file.');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function clearAll() {
            // ... (clearAll function remains largely the same, ensure it calls addService() at the end)
            if (confirm('Are you sure you want to clear all data? This action cannot be undone.')) {
                const formElements = document.querySelectorAll(
                    '#clientName, #clientContact, #clientAddress, #referenceSite, #termsConditions, input[type="number"]'
                );
                formElements.forEach(element => {
                    element.value = '';
                });
                
                document.getElementById('servicesContainer').innerHTML = '';
                services = [];
                serviceCounter = 0; 
                
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('quotationDate').value = today;
                const validUntil = new Date();
                validUntil.setDate(validUntil.getDate() + 30);
                document.getElementById('validUntil').value = validUntil.toISOString().split('T')[0];
                document.getElementById('quotationNumber').value = 'QSAITS-' + Date.now().toString().slice(-5);
                
                document.getElementById('termsConditions').value = `1. Payment Terms: Payment is due within 30 days of invoice date.
2. Scope of Work: This quotation covers the services outlined above. Any additional work will be quoted separately.
3. Validity: This quotation is valid for 30 days from the date mentioned above.
4. Cancellation: Either party may cancel this agreement with 30 days written notice for recurring services.
5. Intellectual Property: Upon full payment for custom development (one-time services), intellectual property rights for the deliverables will transfer to the client, unless otherwise specified for licensed software/platforms or ongoing services.
6. Liability: Our liability is limited to the total value of this contract for the specific service in question.
7. Force Majeure: Neither party shall be liable for delays due to circumstances beyond their control.
8. Governing Law: This agreement shall be governed by the laws of [Your Jurisdiction, e.g., India].`;
                
                addService(); 
                updateTable();
                updateSummary();
                alert('All data cleared.');
            }
        }

        async function generatePDF() {
            // ... (generatePDF function remains the same as previous version)
            if (!validateForm()) {
                return;
            }
            
            const { jsPDF } = window.jspdf; 
            const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
            
            const themeOrange = [249, 115, 22];    
            const themeDarkOrange = [234, 88, 12];  
            const themeBlack = [17, 24, 39];       
            const themeGray = [55, 65, 81];        
            const themeLightGray = [229, 231, 235];
            const themeWhite = [255, 255, 255];

            const pageMargin = 15;
            const contentWidth = pdf.internal.pageSize.getWidth() - 2 * pageMargin;
            let yPosition = pageMargin;

            function checkAndAddPage(increment = 10) {
                if (yPosition + increment > pdf.internal.pageSize.getHeight() - pageMargin) {
                    pdf.addPage();
                    yPosition = pageMargin;
                }
            }
            
            if (companyLogoBase64 && companyLogoBase64 !== "YOUR_LOGO_BASE64_STRING_HERE") {
                try {
                    const imgProps = pdf.getImageProperties(companyLogoBase64);
                    const logoHeight = 15; 
                    const logoWidth = (imgProps.width * logoHeight) / imgProps.height;
                    pdf.addImage(companyLogoBase64, 'PNG', pageMargin, yPosition, logoWidth, logoHeight);
                    yPosition += logoHeight + 5; 
                } catch (e) {
                    console.error("Error adding logo to PDF:", e);
                }
            } else {
                 yPosition += 5; 
            }
            checkAndAddPage();

            pdf.setFontSize(20);
            pdf.setTextColor(...themeOrange);
            pdf.setFont(undefined, 'bold');
            pdf.text('QUOTATION', pdf.internal.pageSize.getWidth() - pageMargin, yPosition, { align: 'right' });
            pdf.setFont(undefined, 'normal');
            yPosition += 10;
            checkAndAddPage();
            
            const detailsStartY = yPosition;
            pdf.setFontSize(9);
            pdf.setTextColor(...themeGray);
            pdf.setFont(undefined, 'bold');
            pdf.text('FROM:', pageMargin, yPosition);
            pdf.setFont(undefined, 'normal');
            yPosition += 5;
            
            pdf.setTextColor(...themeBlack);
            pdf.setFontSize(8);
            pdf.text(companyDetails.name, pageMargin, yPosition); yPosition += 4;
            companyDetails.addressLines.forEach(line => {
                pdf.text(line, pageMargin, yPosition); yPosition += 4;
            });
            pdf.text(`Website: ${companyDetails.website}`, pageMargin, yPosition); yPosition += 4;
            pdf.text(`Contact: ${companyDetails.contact}`, pageMargin, yPosition); yPosition += 4;
            pdf.text(`Email: ${companyDetails.email}`, pageMargin, yPosition); yPosition += 4;

            let rightColX = pdf.internal.pageSize.getWidth() / 2 + 10;
            let tempY = detailsStartY; 
            pdf.setFontSize(8);

            function addDetail(label, value) {
                pdf.setTextColor(...themeGray);
                pdf.setFont(undefined, 'bold');
                pdf.text(label, rightColX, tempY);
                pdf.setTextColor(...themeBlack);
                pdf.setFont(undefined, 'normal');
                pdf.text(value, rightColX + 28, tempY);
                tempY += 5;
            }
            addDetail('Quotation #:', document.getElementById('quotationNumber').value);
            addDetail('Date:', document.getElementById('quotationDate').value);
            addDetail('Valid Until:', document.getElementById('validUntil').value);
            if (document.getElementById('referenceSite').value) {
                addDetail('Reference:', document.getElementById('referenceSite').value);
            }

            yPosition = Math.max(yPosition, tempY) + 8; 
            checkAndAddPage();
            pdf.setFontSize(9);
            pdf.setTextColor(...themeGray);
            pdf.setFont(undefined, 'bold');
            pdf.text('TO:', pageMargin, yPosition);
            pdf.setFont(undefined, 'normal');
            yPosition += 5;
            
            pdf.setTextColor(...themeBlack);
            pdf.setFontSize(8);
            pdf.text(document.getElementById('clientName').value, pageMargin, yPosition); yPosition += 4;
            const clientAddressLines = document.getElementById('clientAddress').value.split('\n');
            clientAddressLines.forEach(line => {
                pdf.text(line, pageMargin, yPosition); yPosition += 4;
            });
            pdf.text(document.getElementById('clientContact').value, pageMargin, yPosition);
            
            yPosition += 10; 
            checkAndAddPage();
            
            pdf.setFontSize(11);
            pdf.setTextColor(...themeDarkOrange);
            pdf.setFont(undefined, 'bold');
            pdf.text('SERVICES', pageMargin, yPosition);
            pdf.setFont(undefined, 'normal');
            yPosition += 7;
            checkAndAddPage();
            
            const tableHeaders = ['Service', 'Description', 'Term', 'Cost'];
            const colWidths = [contentWidth * 0.25, contentWidth * 0.40, contentWidth * 0.15, contentWidth * 0.20];
            
            pdf.setFontSize(8);
            pdf.setFillColor(...themeBlack); 
            pdf.setTextColor(...themeWhite); 
            pdf.setFont(undefined, 'bold');
            pdf.rect(pageMargin, yPosition - 4, contentWidth, 7, 'F'); 
            let currentX = pageMargin + 2;
            tableHeaders.forEach((header, i) => {
                const align = (i === 3 ? 'right' : 'left');
                const textX = (align === 'right') ? (currentX + colWidths[i] - 2) : currentX;
                pdf.text(header, textX, yPosition, { align: align, maxWidth: colWidths[i] - 4 });
                currentX += colWidths[i];
            });
            pdf.setFont(undefined, 'normal');
            yPosition += 6; 
            
            pdf.setTextColor(...themeBlack);
            pdf.setFontSize(7.5); 
            services.forEach((service, index) => {
                checkAndAddPage(15); 
                const rowStartY = yPosition;
                let maxRowHeight = 0;
                const cellPadding = 1.5;

                let serviceNameLines = pdf.splitTextToSize(service.name, colWidths[0] - 4);
                pdf.text(serviceNameLines, pageMargin + 2, yPosition);
                maxRowHeight = Math.max(maxRowHeight, serviceNameLines.length * 3.5);

                let descLines = pdf.splitTextToSize(service.description, colWidths[1] - 4);
                pdf.text(descLines, pageMargin + colWidths[0] + 2, yPosition);
                maxRowHeight = Math.max(maxRowHeight, descLines.length * 3.5);
                
                pdf.text(service.paymentTerm, pageMargin + colWidths[0] + colWidths[1] + 2, yPosition);
                maxRowHeight = Math.max(maxRowHeight, 1 * 3.5); 
                
                let costText = (service.cost > 0 ? '$' + service.cost.toFixed(2) : '-');
                pdf.text(costText, pageMargin + contentWidth - 2 , yPosition, { align: 'right', maxWidth: colWidths[3] - 4 });
                maxRowHeight = Math.max(maxRowHeight, 1 * 3.5); 

                if (index % 2 !== 0) {
                    pdf.setFillColor(...themeLightGray);
                    pdf.rect(pageMargin, rowStartY - cellPadding, contentWidth, maxRowHeight + cellPadding*2 -1 , 'F');
                    pdf.setTextColor(...themeBlack); 
                    pdf.text(serviceNameLines, pageMargin + 2, yPosition);
                    pdf.text(descLines, pageMargin + colWidths[0] + 2, yPosition);
                    pdf.text(service.paymentTerm, pageMargin + colWidths[0] + colWidths[1] + 2, yPosition);
                    pdf.text(costText, pageMargin + contentWidth - 2 , yPosition, { align: 'right', maxWidth: colWidths[3] - 4 });
                }
                
                yPosition = rowStartY + maxRowHeight + cellPadding * 2 - 1; 
                pdf.setDrawColor(...themeLightGray);
                pdf.line(pageMargin, yPosition -1, pageMargin + contentWidth, yPosition -1); 
            });
            pdf.setDrawColor(...themeBlack); 
            
            yPosition += 8; 
            checkAndAddPage();
            
            pdf.setFontSize(11);
            pdf.setTextColor(...themeDarkOrange);
            pdf.setFont(undefined, 'bold');
            pdf.text('COST SUMMARY', pageMargin, yPosition);
            pdf.setFont(undefined, 'normal');
            yPosition += 7;
            checkAndAddPage();

            const summaryLabelX = pageMargin + contentWidth - 60; 
            const summaryAmountX = pageMargin + contentWidth - 5; 
            
            pdf.setFontSize(8);
            
            function addSummarySection(title, term) {
                const filteredServices = services.filter(s => s.paymentTerm === term && s.cost > 0);
                if (filteredServices.length > 0) {
                    const subtotal = filteredServices.reduce((sum, s) => sum + s.cost, 0);
                    const tax = subtotal * 0.1; 
                    const total = subtotal + tax;

                    pdf.setTextColor(...themeBlack);
                    pdf.setFont(undefined, 'bold');
                    pdf.text(title, pageMargin, yPosition);
                    pdf.setFont(undefined, 'normal');
                    yPosition += 5; checkAndAddPage(5);

                    pdf.setTextColor(...themeGray);
                    pdf.text('Subtotal:', summaryLabelX, yPosition, {align: 'right'});
                    pdf.setTextColor(...themeBlack);
                    pdf.text('$' + subtotal.toFixed(2), summaryAmountX, yPosition, { align: 'right'});
                    yPosition += 5; checkAndAddPage(5);

                    pdf.setTextColor(...themeGray);
                    pdf.text('Tax (10%):', summaryLabelX, yPosition, {align: 'right'});
                    pdf.setTextColor(...themeBlack);
                    pdf.text('$' + tax.toFixed(2), summaryAmountX, yPosition, { align: 'right'});
                    yPosition += 5; checkAndAddPage(5);
                    
                    pdf.setDrawColor(...themeLightGray);
                    pdf.line(summaryLabelX - 10, yPosition - 2, summaryAmountX, yPosition - 2);

                    pdf.setFont(undefined, 'bold');
                    pdf.setTextColor(...themeBlack);
                    pdf.text('Total:', summaryLabelX, yPosition, {align: 'right'});
                    pdf.text('$' + total.toFixed(2), summaryAmountX, yPosition, { align: 'right'});
                    pdf.setFont(undefined, 'normal');
                    yPosition += 8; checkAndAddPage(8);
                }
            }
            addSummarySection('One-Time Payment:', 'One-Time');
            addSummarySection('Monthly Recurring Payment:', 'Monthly');
            addSummarySection('Yearly Recurring Payment:', 'Yearly');
            
            yPosition += 5; 
            checkAndAddPage();
            
            pdf.setFontSize(11);
            pdf.setTextColor(...themeDarkOrange);
            pdf.setFont(undefined, 'bold');
            pdf.text('TERMS AND CONDITIONS', pageMargin, yPosition);
            pdf.setFont(undefined, 'normal');
            yPosition += 7;
            checkAndAddPage();
            
            pdf.setFontSize(7.5);
            pdf.setTextColor(...themeGray);
            const termsText = document.getElementById('termsConditions').value;
            const termsLines = pdf.splitTextToSize(termsText, contentWidth); 
            termsLines.forEach(line => {
                checkAndAddPage(3.5); 
                pdf.text(line, pageMargin, yPosition);
                yPosition += 3.5;
            });
            
            yPosition += 15; 
            checkAndAddPage(30); 
            
            pdf.setFontSize(8);
            pdf.setTextColor(...themeGray);
            const signatureWidth = contentWidth / 2 - 10; 
            
            pdf.text('Company Signature:', pageMargin, yPosition);
            pdf.setDrawColor(...themeBlack);
            pdf.line(pageMargin, yPosition + 12, pageMargin + signatureWidth, yPosition + 12); 
            pdf.text('Date:', pageMargin, yPosition + 18);
            pdf.line(pageMargin + 15, yPosition + 18, pageMargin + signatureWidth, yPosition + 18); 

            const clientSigX = pageMargin + contentWidth / 2 + 5;
            pdf.text('Client Signature:', clientSigX, yPosition);
            pdf.line(clientSigX, yPosition + 12, clientSigX + signatureWidth, yPosition + 12); 
            pdf.text('Date:', clientSigX, yPosition + 18);
            pdf.line(clientSigX + 15, yPosition + 18, clientSigX + signatureWidth, yPosition + 18); 
            
            const pageCount = pdf.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                pdf.setPage(i);
                pdf.setFontSize(7);
                pdf.setTextColor(...themeGray);
                pdf.text(companyDetails.name, pageMargin, pdf.internal.pageSize.getHeight() - pageMargin/2, {align: 'left'});
                pdf.text(`Page ${i} of ${pageCount}`, pdf.internal.pageSize.getWidth() - pageMargin, pdf.internal.pageSize.getHeight() - pageMargin/2, {align: 'right'});
            }

            const clientNameForFile = document.getElementById('clientName').value.replace(/\s+/g, '_') || 'Client';
            const quoteNumForFile = document.getElementById('quotationNumber').value || 'Quote';
            const filename = `Quotation_${quoteNumForFile}_${clientNameForFile}.pdf`;
            pdf.save(filename);
        }

    </script>
</body>
</html>
